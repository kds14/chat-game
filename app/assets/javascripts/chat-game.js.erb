const playerSpeed = 5;
const gameWidth = 640;
const gameHeight = 480;
const backgroundColor = 0x29a329;

const app = new PIXI.Application({
    width: gameWidth,
    height: gameHeight,
    backgroundColor: backgroundColor
});
document.body.appendChild(app.view);

const menuStage = new PIXI.Container();
const gameStage = new PIXI.Container();

gameStage.interactive = true;
gameStage.hitArea = new PIXI.Rectangle(0, 0, gameWidth, gameHeight);
gameStage.on("mousedown", onClick);

const loader = PIXI.loader;
loader.add('joinButton', "<%= image_path('join_button.png') %>");
loader.add('player', "<%= image_path('face.png') %>")
const sprites = {};

app.stage = menuStage;

let prevTime = 0;

loader.load((loader, resources) =>
{
    sprites.joinButton = new PIXI.Sprite(resources.joinButton.texture);

    sprites.joinButton.anchor.set(0.5);
    sprites.joinButton.x = gameWidth / 2;
    sprites.joinButton.y = gameHeight / 2;
    sprites.joinButton.interactable
    sprites.joinButton.interactive = true;
    sprites.joinButton.buttonMode = true;
    sprites.joinButton.on("pointerdown", onJoinClick);
    menuStage.addChild(sprites.joinButton);

    sprites.player = new PIXI.Sprite(resources.player.texture);

    sprites.player.anchor.set(0.5);
    sprites.player.x = 50;
    sprites.player.y = 50;
    sprites.player.goal = null;
    gameStage.addChild(sprites.player);

    window.addEventListener("keydown", onKeyDown, false);

    gameLoop(0);
});

function onJoinClick(e)
{
    app.stage = gameStage;
}

function update(delta)
{
    switch(app.stage)
    {
        case menuStage:
            break;
        case gameStage:
            handleMovement(sprites.player);
            break;
        default:
            break;
    }
}

function gameLoop(currentTime)
{
    let delta = currentTime - prevTime;
    update(delta);
    prevTime = currentTime;
    window.requestAnimationFrame(gameLoop);
}

function playerPos(player)
{
    let x = player.x + player.width / 2;
    let y = player.y + player.height / 2;
    return { x:x, y:y };
}

function handleMovement(player)
{
    if (player.goal !== null)
    {
        // calculate distance to move x and y
        let xDelta = player.goal.x - player.x;
        let yDelta = player.goal.y - player.y;

        if (Math.abs(xDelta) + Math.abs(yDelta) < 5)
        {
            player.x = player.goal.x;
            player.y = player.goal.y;
            player.goal = null;
        }

        let theta = Math.atan(xDelta / yDelta);
        let x = Math.abs(Math.sin(theta));
        let y = Math.abs(Math.cos(theta));

        player.x += Math.sign(xDelta) * x * playerSpeed;
        player.y += Math.sign(yDelta) * y * playerSpeed;

    }
}

function onClick(e)
{
    sprites.player.goal = { x:0, y:0 }
    sprites.player.goal.x = e.data.global.x
    sprites.player.goal.y = e.data.global.y
}

function onKeyDown(e)
{
    e.preventDefault();
    if (e.key.length === 1)
    {
        console.log(e.key);
    }
}

