const playerSpeed = 5;
const gameWidth = 640;
const gameHeight = 480;
const backgroundColor = 0x29a329;
const buttonWidth = 128;
const buttonHeight = 64;
const url = "http://localhost:3000/";
const menuColorMain = 0xFFFFFF;
const menuColorSec = 0x000000;
const joinMenuTop = gameHeight / 2 - 192;
const joinMenuLeft = gameWidth / 2 - 128;
const joinMenuWidth = 256;
const joinMenuHeight = 384;

const app = new PIXI.Application({
    width: gameWidth,
    height: gameHeight,
    backgroundColor: backgroundColor
});
document.body.appendChild(app.view);

const menuStage = new PIXI.Container();
const gameStage = new PIXI.Container();
const joinStage = new PIXI.Container();

gameStage.interactive = true;
gameStage.hitArea = new PIXI.Rectangle(0, 0, gameWidth, gameHeight);
gameStage.on("mousedown", onClick);

const loader = PIXI.loader;
loader.add('joinButton', "<%= image_path('join_button.png') %>");
loader.add('player', "<%= image_path('face.png') %>")
const sprites = {};
let otherPlayers = [];
let playerTexture;
let prevTime = 0;

app.stage = menuStage;

// menuStage setup
createButton(gameWidth / 2, gameHeight / 2, "JOIN", onJoinClick, menuStage);

// joinStage setup
let joinMenu = createRectangle(menuColorMain, menuColorSec, 5, joinMenuLeft,
    joinMenuTop, joinMenuWidth, joinMenuHeight);
joinStage.addChild(joinMenu);
getRoomsRequest();

// after all assets are loaded
loader.load((loader, resources) =>
{
    playerTexture = resources.player.texture
    sprites.player = new PIXI.Sprite(playerTexture);

    sprites.player.anchor.set(0.5);
    sprites.player.x = 50;
    sprites.player.y = 50;
    sprites.player.goal = null;
    gameStage.addChild(sprites.player);

    window.addEventListener("keydown", onKeyDown, false);

    gameLoop(0);
});

function onGetRoomsResponse()
{
    // populate joinMenu with interactable room buttons
    let r = JSON.parse(this.responseText);
    if(r !== null && r.hasOwnProperty("rooms") && r.rooms.length > 0)
    {
        for(let i = 0; i < r.rooms.length; i++)
        {
            let s = "Room " + i + " (" + r.rooms[i].players.length + " players)"
            let style = new PIXI.TextStyle({fill: "#000000"});
            const text = new PIXI.Text(s, style);
            text.anchor.set(0.5);
            text.x = gameWidth / 2;
            text.y = joinMenuTop + + text.height * (i+1);
            text.interactive = true;
            text.mouseover = function(e)
            {
                text.style.fill = "#00e64d";
            }
            text.mouseout = function(e)
            {
                text.style.fill = "#000000";
            }
            text.on("pointerdown", function(e)
            {
                joinRoomRequest(i);
            });
            joinMenu.addChild(text);
        }
    }
}

function onJoinRoomResponse()
{
    console.log(this.responseText);
    let r = JSON.parse(this.responseText);
    if(r !== null && r.hasOwnProperty("room"))
    {
        app.stage = gameStage;
        update_players(r.room.players, r.client_id);
    }
}

function joinRoomRequest(room)
{
    let req = new XMLHttpRequest();
    req.open("POST", url + "game/join");
    req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    req.addEventListener("load", onJoinRoomResponse);
    req.send("room=" + room);
}

function getRoomsRequest()
{
    let req = new XMLHttpRequest();
    req.open("GET", url + "game/rooms");
    req.addEventListener("load", onGetRoomsResponse);
    req.send();
}

function createRectangle(fColor, lColor, lthickness, x, y, w, h)
{
    const rect = new PIXI.Graphics();
    rect.beginFill(fColor);
    rect.lineStyle(lthickness, lColor);
    rect.drawRect(x, y, w, h);
    return rect;
}

function createButton(x, y, text, onButtonClick, stage)
{
    const button = createRectangle(menuColorMain, menuColorSec, 5, x - (buttonWidth / 2),
        y - (buttonHeight /2), buttonWidth, buttonHeight);
    button.buttonMode = true;
    button.interactive = true;
    button.on("pointerdown", onButtonClick);
    const btext = new PIXI.Text(text);
    btext.anchor.set(0.5);
    btext.x = x;
    btext.y = y;
    button.addChild(btext);
    stage.addChild(button);
}

function onJoinClick(e)
{
    app.stage = joinStage;
}

function onLoad()
{
    let r = JSON.parse(this.responseText);
    if(r !== null && r.hasOwnProperty("room"))
    {
        app.stage = gameStage;
        update_players(r.room.players, r.client_id);
    }
}

function update_players(players, client_id)
{
    for(let p in players)
    {
        let r = null;
        if(client_id === players[p].id)
        {
            //continue;
            r = sprites.player;
        }
        else
        {   
            r = otherPlayers.find(item => item.id === players[p].id);
            if(r == null)
            {
                r = new PIXI.Sprite(playerTexture);
                r.x = players[p].goal_x
                r.y = players[p].goal_y
                r.id = players[p].id
                otherPlayers.push(r)
                gameStage.addChild(r);
            }
        }
        r.goal = { x: players[p].goal_x, y: players[p].goal_y };
    }
}

function onHostClick(e)
{
    let req = new XMLHttpRequest();
    req.open("GET", url + "game/create");
    req.addEventListener("load", onLoad);
    req.send();
}

function update(delta)
{
    switch(app.stage)
    {
        case menuStage:
            break;
        case gameStage:
            handleMovement(sprites.player);
            for(let p in otherPlayers)
            {
                handleMovement(p);
            }
            break;
        default:
            break;
    }
}

function gameLoop(currentTime)
{
    let delta = currentTime - prevTime;
    update(delta);
    prevTime = currentTime;
    window.requestAnimationFrame(gameLoop);
}

function playerPos(player)
{
    let x = player.x + player.width / 2;
    let y = player.y + player.height / 2;
    return { x:x, y:y };
}

function handleMovement(player)
{
    if (player.goal != null)
    {
        // calculate distance to move x and y
        let xDelta = player.goal.x - player.x;
        let yDelta = player.goal.y - player.y;

        if (Math.abs(xDelta) + Math.abs(yDelta) < 5)
        {
            player.x = player.goal.x;
            player.y = player.goal.y;
            player.goal = null;
            return;
        }

        let theta = Math.atan(xDelta / yDelta);
        let x = Math.abs(Math.sin(theta));
        let y = Math.abs(Math.cos(theta));

        player.x += Math.sign(xDelta) * x * playerSpeed;
        player.y += Math.sign(yDelta) * y * playerSpeed;

    }
}

function onClick(e)
{
    sprites.player.goal = { x:0, y:0 }
    sprites.player.goal.x = e.data.global.x
    sprites.player.goal.y = e.data.global.y
}

function onKeyDown(e)
{
    e.preventDefault();
    if (e.key.length === 1)
    {
        console.log(e.key);
    }
}

